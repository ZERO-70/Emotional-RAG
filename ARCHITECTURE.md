# ğŸ—ï¸ Enhanced Emotional RAG - System Architecture

## Visual Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER MESSAGE                                â”‚
â”‚                    "I feel lonely today"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: EMOTION DETECTION                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RoBERTa Model (cardiffnlp/twitter-roberta-base-emotion)        â”‚ â”‚
â”‚  â”‚ Output: "sadness" (confidence: 0.87)                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: EMOTION-AWARE RETRIEVAL                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ A. Semantic Embedding (Sentence Transformers)                  â”‚ â”‚
â”‚  â”‚    "lonely" â†’ [0.23, -0.45, 0.67, ...]                         â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ B. Query ChromaDB (n=10 candidates)                            â”‚ â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚    â”‚ Doc 1: "I miss my friends" (emotion: sadness)           â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 2: "Feeling isolated" (emotion: sadness)            â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 3: "Great day today!" (emotion: joy)                â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 4: "I'm anxious about work" (emotion: fear)         â”‚â”‚ â”‚
â”‚  â”‚    â”‚ ...                                                      â”‚â”‚ â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ C. Re-rank with Hybrid Scoring                                 â”‚ â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚    â”‚ For each document:                                      â”‚â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚â”‚ â”‚
â”‚  â”‚    â”‚ score = 0.6 Ã— semantic_similarity                       â”‚â”‚ â”‚
â”‚  â”‚    â”‚       + 0.4 Ã— emotion_similarity                        â”‚â”‚ â”‚
â”‚  â”‚    â”‚       + 0.1 Ã— recency_boost                             â”‚â”‚ â”‚
â”‚  â”‚    â”‚                                                          â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 1: 0.6Ã—0.85 + 0.4Ã—1.0 + 0.1Ã—0.9 = 1.00 âœ…          â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 2: 0.6Ã—0.78 + 0.4Ã—1.0 + 0.1Ã—0.7 = 0.94 âœ…          â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 4: 0.6Ã—0.72 + 0.4Ã—0.7 + 0.1Ã—0.8 = 0.79 âœ…          â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Doc 3: 0.6Ã—0.81 + 0.4Ã—0.3 + 0.1Ã—0.6 = 0.61 âŒ          â”‚â”‚ â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ D. Return Top 5                                                 â”‚ â”‚
â”‚  â”‚    ["I miss my friends", "Feeling isolated", ...]              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: CONVERSATION STATE RETRIEVAL                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Recent Turns (Last 3):                                         â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚ â”‚ Turn 1: User (joy): "Got a promotion!"                     â”‚â”‚ â”‚
â”‚  â”‚ â”‚         Bot: "That's wonderful! Tell me more..."           â”‚â”‚ â”‚
â”‚  â”‚ â”‚                                                             â”‚â”‚ â”‚
â”‚  â”‚ â”‚ Turn 2: User (surprise): "It's a big responsibility"      â”‚â”‚ â”‚
â”‚  â”‚ â”‚         Bot: "Change brings new challenges..."            â”‚â”‚ â”‚
â”‚  â”‚ â”‚                                                             â”‚â”‚ â”‚
â”‚  â”‚ â”‚ Turn 3: User (sadness): "I feel lonely today"             â”‚â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ Emotional Journey: joy â†’ surprise â†’ sadness                    â”‚ â”‚
â”‚  â”‚ Dominant Emotion: sadness                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: CHARACTER-AWARE PROMPT BUILDING                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ # YOUR ROLE                                                    â”‚ â”‚
â”‚  â”‚ Name: Aria                                                     â”‚ â”‚
â”‚  â”‚ Personality: empathetic, supportive, non-judgmental           â”‚ â”‚
â”‚  â”‚ Emotional Intelligence: 90%                                    â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ # EMOTIONAL CONTEXT                                            â”‚ â”‚
â”‚  â”‚ User emotion: sadness                                          â”‚ â”‚
â”‚  â”‚ Empathy Level: 95%                                             â”‚ â”‚
â”‚  â”‚ Response Style: deeply empathetic, validating, gentle         â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ # RELEVANT MEMORIES                                            â”‚ â”‚
â”‚  â”‚ [Retrieved context from RAG]                                   â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ # RECENT CONVERSATION                                          â”‚ â”‚
â”‚  â”‚ [Last 3 turns from conversation state]                         â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ # CURRENT INTERACTION                                          â”‚ â”‚
â”‚  â”‚ User: I feel lonely today                                      â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ # YOUR RESPONSE                                                â”‚ â”‚
â”‚  â”‚ Respond as Aria, maintaining character traits...              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: LLM GENERATION (Gemini)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Model: gemini-1.5-flash                                        â”‚ â”‚
â”‚  â”‚ Temperature: 0.8 (creative but consistent)                     â”‚ â”‚
â”‚  â”‚ Max Tokens: 500                                                 â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ â†’ "I hear the sadness in your words, and I want you to know   â”‚ â”‚
â”‚  â”‚    that's completely valid. Earlier, you shared the joy of    â”‚ â”‚
â”‚  â”‚    your promotion, and now you're experiencing this lonelinessâ”‚ â”‚
â”‚  â”‚    - that's a real emotional shift. What do you think is      â”‚ â”‚
â”‚  â”‚    contributing to these feelings of isolation?"               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: MULTI-LAYER MEMORY STORAGE                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ A. ChromaDB (Vector Store)                                     â”‚ â”‚
â”‚  â”‚    â”œâ”€ Document: "I feel lonely today"                          â”‚ â”‚
â”‚  â”‚    â”œâ”€ Embedding: [0.23, -0.45, 0.67, ...]                      â”‚ â”‚
â”‚  â”‚    â”œâ”€ Metadata: {emotion: "sadness", speaker: "user",          â”‚ â”‚
â”‚  â”‚    â”‚             timestamp: 1729180234, bot_reply: "..."}      â”‚ â”‚
â”‚  â”‚    â””â”€ ID: "1729180234_a3f7b2c9"                                â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ B. JSON Memory (data/memory.json)                              â”‚ â”‚
â”‚  â”‚    â”œâ”€ Full conversation history                                â”‚ â”‚
â”‚  â”‚    â””â”€ {user_text, user_emotion, bot_reply}                     â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ C. Conversation State (data/conversation_state.json)           â”‚ â”‚
â”‚  â”‚    â”œâ”€ Last 10 turns                                            â”‚ â”‚
â”‚  â”‚    â”œâ”€ Emotion history: [joy, surprise, sadness, ...]           â”‚ â”‚
â”‚  â”‚    â””â”€ Dominant emotion: sadness                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESPONSE TO USER                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ {                                                              â”‚ â”‚
â”‚  â”‚   "reply": "I hear the sadness in your words...",             â”‚ â”‚
â”‚  â”‚   "user_emotion": "sadness",                                  â”‚ â”‚
â”‚  â”‚   "retrieved_context": ["I miss my friends", ...],            â”‚ â”‚
â”‚  â”‚   "emotional_summary": "We've discussed sadness 3 times...",  â”‚ â”‚
â”‚  â”‚   "conversation_stats": {                                     â”‚ â”‚
â”‚  â”‚     "turn_count": 3,                                          â”‚ â”‚
â”‚  â”‚     "dominant_emotion": "sadness",                            â”‚ â”‚
â”‚  â”‚     "emotional_journey": "joy â†’ surprise â†’ sadness"           â”‚ â”‚
â”‚  â”‚   },                                                          â”‚ â”‚
â”‚  â”‚   "character": "Aria"                                         â”‚ â”‚
â”‚  â”‚ }                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Innovations

### 1. **Emotion Similarity Scoring**
```
Same Emotion:        1.0  (perfect match)
Same Group:          0.7  (high similarity)
Different Groups:    0.3  (baseline similarity)

Groups:
- Negative: [sadness, anger, fear, disgust]
- Positive: [joy, happiness, excitement, love]
- Neutral:  [surprise, neutral, curiosity]
```

### 2. **Hybrid Retrieval Score**
```python
score = (1 - emotion_weight) Ã— semantic_score 
        + emotion_weight Ã— emotion_score 
        + 0.1 Ã— recency_score

# Default: emotion_weight = 0.4
# Adjustable per request
```

### 3. **Character Consistency**
```
Persona â†’ Response Patterns â†’ Empathy Levels â†’ Speaking Style
    â†“           â†“                    â†“                â†“
  Traits    Guidance per         Adjustable      Natural
            emotion type         per emotion     language
```

### 4. **Three-Layer Memory**
```
Vector DB          JSON Log           State Tracker
    â†“                  â†“                    â†“
Semantic +         Full history      Emotional arc +
Emotional search                     Recent context
```

## Data Flow Example

### Input
```json
{
  "message": "I feel lonely today",
  "emotion_weight": 0.4,
  "use_recent_context": true
}
```

### Processing
1. **Emotion Detection**: `"sadness"` (0.87 confidence)
2. **Retrieval**: 5 docs (4 with sadness/fear, 1 neutral)
3. **State**: Recent history shows joy â†’ surprise â†’ sadness
4. **Character**: Aria (empathy 95% for sadness)
5. **Prompt**: 1450 chars with all context
6. **Generation**: ~200 tokens, temp 0.8
7. **Storage**: 3 locations (vector, JSON, state)

### Output
```json
{
  "reply": "Emotionally aware, character-consistent response",
  "user_emotion": "sadness",
  "retrieved_context": [...],
  "emotional_summary": "...",
  "conversation_stats": {...}
}
```

## Performance Characteristics

- **Retrieval Time**: ~50-100ms (embedding + DB query + re-ranking)
- **LLM Generation**: ~1-2s (depends on Gemini API)
- **Total Response**: ~1.5-2.5s
- **Memory Growth**: Linear with conversation turns
- **Storage**: ~1KB per turn

## Scalability Considerations

### Current Design (Single User)
- In-memory conversation state
- Single ChromaDB collection
- File-based state persistence

### Multi-User Scaling (Future)
- Session-based state management
- Per-user ChromaDB collections
- Redis/Database for state
- Load balancing for LLM calls

---

This architecture creates a truly **emotionally intelligent AI** that:
âœ… Remembers emotions, not just words
âœ… Maintains consistent personality
âœ… Tracks conversation context
âœ… Adapts to emotional moments
âœ… Builds long-term relationships
